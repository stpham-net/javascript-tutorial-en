
# L·∫∑p l·∫°i (Iterables)

C√°c ƒë·ªëi t∆∞·ª£ng *iterable* l√† m·ªôt t·ªïng qu√°t h√≥a (ho·∫∑c c≈©ng g·ªçi l√† s·ª± suy r·ªông (generalization)) c·ªßa c√°c m·∫£ng. ƒê√≥ l√† m·ªôt kh√°i ni·ªám cho ph√©p l√†m cho b·∫•t k·ª≥ ƒë·ªëi t∆∞·ª£ng n√†o c√≥ th·ªÉ s·ª≠ d·ª•ng ƒë∆∞·ª£c trong m·ªôt v√≤ng l·∫∑p `for..of`.

T·∫•t nhi√™n, M·∫£ng l√† l·∫∑p ƒëi l·∫∑p l·∫°i. Nh∆∞ng c√≥ nhi·ªÅu built-in objects kh√°c, c≈©ng c√≥ th·ªÉ l·∫∑p l·∫°i. Ch·∫≥ng h·∫°n, Strings c≈©ng c√≥ th·ªÉ l·∫∑p l·∫°i. Nh∆∞ ch√∫ng ta s·∫Ω th·∫•y, nhi·ªÅu built-in to√°n t·ª≠ v√† ph∆∞∆°ng th·ª©c d·ª±a v√†o ch√∫ng.

N·∫øu m·ªôt ƒë·ªëi t∆∞·ª£ng ƒë·∫°i di·ªán cho m·ªôt b·ªô s∆∞u t·∫≠p (danh s√°ch, t·∫≠p h·ª£p) c·ªßa m·ªôt c√°i g√¨ ƒë√≥, th√¨ `for..of` l√† m·ªôt c√∫ ph√°p tuy·ªát v·ªùi ƒë·ªÉ l·∫∑p l·∫°i n√≥, v√¨ v·∫≠y h√£y xem c√°ch l√†m cho n√≥ l√†m vi·ªác.


## Symbol.iterator

Ch√∫ng ta c√≥ th·ªÉ d·ªÖ d√†ng n·∫Øm b·∫Øt kh√°i ni·ªám l·∫∑p ƒëi l·∫∑p l·∫°i (concept of iterables) b·∫±ng c√°ch t·∫°o ra m·ªôt trong nh·ªØng c√°i ch√∫ng ta s·ªü h·ªØu.

Ch·∫≥ng h·∫°n, ch√∫ng ta c√≥ m·ªôt ƒë·ªëi t∆∞·ª£ng, ƒë√≥ kh√¥ng ph·∫£i l√† m·ªôt m·∫£ng, nh∆∞ng c√≥ v·∫ª ph√π h·ª£p v·ªõi `for..of`.

Gi·ªëng nh∆∞ m·ªôt ƒë·ªëi t∆∞·ª£ng `range` ƒë·∫°i di·ªán cho m·ªôt kho·∫£ng s·ªë:

```js
      let range = {
        from: 1,
        to: 5
      };

      // We want the for..of to work:
      // for(let num of range) ... num=1,2,3,4,5
```

ƒê·ªÉ l√†m cho `range` c√≥ th·ªÉ l·∫∑p l·∫°i (v√† ƒë·ªÉ cho `for..of` l√†m vi·ªác), ch√∫ng ta c·∫ßn th√™m m·ªôt ph∆∞∆°ng th·ª©c v√†o ƒë·ªëi t∆∞·ª£ng c√≥ t√™n l√† `Symbol.iterator` (m·ªôt built-in symbol ƒë·∫∑c bi·ªát ch·ªâ d√†nh cho ƒëi·ªÅu ƒë√≥).

1. Khi `for..of` b·∫Øt ƒë·∫ßu, n√≥ g·ªçi ph∆∞∆°ng th·ª©c ƒë√≥ m·ªôt l·∫ßn (ho·∫∑c l·ªói n·∫øu kh√¥ng t√¨m th·∫•y). Ph∆∞∆°ng th·ª©c ph·∫£i tr·∫£ v·ªÅ m·ªôt *iterator* -- m·ªôt ƒë·ªëi t∆∞·ª£ng c√≥ ph∆∞∆°ng th·ª©c `next`.
2. T·ª≠ ƒë√≥ tr·ªü ƒëi, `for..of` l√†m vi·ªác *ch·ªâ v·ªõi ƒë·ªëi t∆∞·ª£ng ƒë∆∞·ª£c tr·∫£ v·ªÅ*.
3. Khi `for..of` mu·ªën gi√° tr·ªã ti·∫øp theo, n√≥ g·ªçi `next()` tr√™n ƒë·ªëi t∆∞·ª£ng ƒë√≥.
4. K·∫øt qu·∫£ c·ªßa `next()` ph·∫£i c√≥ d·∫°ng `{done: Boolean, value: any}`, trong ƒë√≥ `done=true` c√≥ nghƒ©a l√† vi·ªác l·∫∑p l·∫°i ƒë√£ k·∫øt th√∫c, n·∫øu kh√¥ng th√¨ `value` ph·∫£i l√† gi√° tr·ªã m·ªõi.

ƒê√¢y l√† c√°ch th·ª±c hi·ªán ƒë·∫ßy ƒë·ªß cho `range`:

```js
      let range = {
        from: 1,
        to: 5
      };

      // 1. call to for..of initially calls this
      range[Symbol.iterator] = function() {

        // ...it returns the iterator object:
        // 2. Onward, for..of works only with this iterator, asking it for next values
        return {
          current: this.from,
          last: this.to,      

          // 3. next() is called on each iteration by the for..of loop
          next() {
            // 4. it should return the value as an object {done:.., value :...}
            if (this.current <= this.last) {
              return { done: false, value: this.current++ };
            } else {
              return { done: true };
            }
          }
        };
      };

      // now it works!
      for (let num of range) {
        alert(num); // 1, then 2, 3, 4, 5
      }
```

Xin l∆∞u √Ω t√≠nh nƒÉng c·ªët l√µi c·ªßa iterables: m·ªôt [separation of concerns](https://en.wikipedia.org/wiki/Separation_of_concerns) quan tr·ªçng:

- B·∫£n th√¢n `range` kh√¥ng c√≥ ph∆∞∆°ng th·ª©c `next()`.
- Thay v√†o ƒë√≥, m·ªôt ƒë·ªëi t∆∞·ª£ng kh√°c, c√°i g·ªçi l√† "iterator" ƒë∆∞·ª£c t·∫°o b·ªüi l·ªánh g·ªçi t·ªõi `range[Symbol.iterator]()` v√† n√≥ x·ª≠ l√Ω to√†n b·ªô l·∫ßn l·∫∑p (iteration).

V√¨ v·∫≠y, ƒë·ªëi t∆∞·ª£ng iterator t√°ch bi·ªát v·ªõi ƒë·ªëi t∆∞·ª£ng m√† n√≥ l·∫∑p ƒëi l·∫∑p l·∫°i.

V·ªÅ m·∫∑t k·ªπ thu·∫≠t, ch√∫ng ta c√≥ th·ªÉ h·ª£p nh·∫•t ch√∫ng v√† s·ª≠ d·ª•ng ch√≠nh `range` l√†m tr√¨nh l·∫∑p (iterator) ƒë·ªÉ l√†m cho m√£ ƒë∆°n gi·∫£n h∆°n.

Nh∆∞ th·∫ø n√†y:

```js
      let range = {
        from: 1,
        to: 5,

        [Symbol.iterator]() {
          this.current = this.from;
          return this;
        },

        next() {
          if (this.current <= this.to) {
            return { done: false, value: this.current++ };
          } else {
            return { done: true };
          }
        }
      };

      for (let num of range) {
        alert(num); // 1, then 2, 3, 4, 5
      }
```

B√¢y gi·ªù `range[Symbol.iterator]()` tr·∫£ v·ªÅ ch√≠nh ƒë·ªëi t∆∞·ª£ng `range`: n√≥ c√≥ ph∆∞∆°ng th·ª©c `next()` c·∫ßn thi·∫øt v√† ghi nh·ªõ ti·∫øn tr√¨nh l·∫∑p hi·ªán t·∫°i trong `this.current`. Ng·∫Øn h∆°n? V√¢ng. V√† ƒë√¥i khi ƒëi·ªÅu ƒë√≥ c≈©ng t·ªët.

Nh∆∞·ª£c ƒëi·ªÉm l√† b√¢y gi·ªù kh√¥ng th·ªÉ c√≥ hai v√≤ng l·∫∑p `for..of` ch·∫°y tr√™n ƒë·ªëi t∆∞·ª£ng c√πng m·ªôt l√∫c: ch√∫ng s·∫Ω chia s·∫ª tr·∫°ng th√°i l·∫∑p, b·ªüi v√¨ ch·ªâ c√≥ m·ªôt v√≤ng l·∫∑p -- ch√≠nh ƒë·ªëi t∆∞·ª£ng ƒë√≥. Nh∆∞ng hai for-ofs song song l√† m·ªôt ƒëi·ªÅu hi·∫øm g·∫∑p, c√≥ th·ªÉ ƒë∆∞·ª£c th·ª±c hi·ªán v·ªõi m·ªôt s·ªë t√¨nh hu·ªëng kh√¥ng ƒë·ªìng b·ªô.

<br>

> ---

**üìå L·∫∑p l·∫°i v√¥ h·∫°n (Infinite iterators)**

L·∫∑p ƒëi l·∫∑p l·∫°i v√¥ h·∫°n c≈©ng c√≥ th·ªÉ. Ch·∫≥ng h·∫°n, `range` tr·ªü th√†nh v√¥ h·∫°n v·ªõi `range.to = Infinity`. Ho·∫∑c ch√∫ng ta c√≥ th·ªÉ t·∫°o m·ªôt iterable object ƒë·ªÉ t·∫°o ra m·ªôt chu·ªói v√¥ s·ªë c√°c s·ªë gi·∫£ ng·∫´u nhi√™n. C≈©ng c√≥ th·ªÉ h·ªØu √≠ch.

Kh√¥ng c√≥ gi·ªõi h·∫°n n√†o v·ªÅ `next`, n√≥ c√≥ th·ªÉ tr·∫£ v·ªÅ ng√†y c√†ng nhi·ªÅu gi√° tr·ªã, ƒëi·ªÅu ƒë√≥ l√† b√¨nh th∆∞·ªùng.

T·∫•t nhi√™n, the `for..of` loop tr√™n m·ªôt v√≤ng l·∫∑p nh∆∞ v·∫≠y s·∫Ω l√† v√¥ t·∫≠n. Nh∆∞ng ch√∫ng ta lu√¥n c√≥ th·ªÉ stop n√≥ b·∫±ng c√°ch s·ª≠ d·ª•ng `break`.

> ---

<br>

## Chu·ªói c√≥ th·ªÉ l·∫∑p l·∫°i (String is iterable)

M·∫£ng v√† chu·ªói ƒë∆∞·ª£c s·ª≠ d·ª•ng built-in iterables r·ªông r√£i nh·∫•t.

ƒê·ªëi v·ªõi m·ªôt chu·ªói, `for..of` l·∫∑p tr√™n c√°c k√Ω t·ª± c·ªßa n√≥:

```js
      for (let char of "test") {
        // triggers 4 times: once for each character
        alert( char ); // t, then e, then s, then t
      }
```

V√† n√≥ ho·∫°t ƒë·ªông ch√≠nh x√°c v·ªõi c√°c c·∫∑p thay th·∫ø (surrogate pairs)!

```js
      let str = 'ùí≥üòÇ';
      for (let char of str) {
          alert( char ); // ùí≥, and then üòÇ
      }
```

## G·ªçi m·ªôt tr√¨nh l·∫∑p r√µ r√†ng (iterator explicitly)

Th√¥ng th∆∞·ªùng, ph·∫ßn b√™n trong c·ªßa iterables ƒë∆∞·ª£c ·∫©n kh·ªèi m√£ b√™n ngo√†i. C√≥ m·ªôt v√≤ng l·∫∑p `for..of`, ho·∫°t ƒë·ªông, ƒë√≥ l√† t·∫•t c·∫£ nh·ªØng g√¨ n√≥ c·∫ßn bi·∫øt.

Nh∆∞ng ƒë·ªÉ hi·ªÉu m·ªçi th·ª© s√¢u h∆°n m·ªôt ch√∫t, h√£y xem c√°ch t·∫°o ra m·ªôt tr√¨nh l·∫∑p m·ªôt c√°ch r√µ r√†ng.

Ch√∫ng ta s·∫Ω l·∫∑p l·∫°i m·ªôt chu·ªói gi·ªëng nh∆∞ `for..of`, nh∆∞ng v·ªõi c√°c cu·ªôc g·ªçi tr·ª±c ti·∫øp. M√£ n√†y nh·∫≠n ƒë∆∞·ª£c m·ªôt tr√¨nh v√≤ng l·∫∑p chu·ªói v√† g·ªçi n√≥ l√† "th·ªß c√¥ng (manually)":

```js
      let str = "Hello";

      // does the same as
      // for (let char of str) alert(char);

      let iterator = str[Symbol.iterator]();

      while (true) {
        let result = iterator.next();
        if (result.done) break;
        alert(result.value); // outputs characters one by one
      }
```

ƒêi·ªÅu ƒë√≥ hi·∫øm khi c·∫ßn thi·∫øt, nh∆∞ng cho ch√∫ng ta nhi·ªÅu quy·ªÅn ki·ªÉm so√°t qu√° tr√¨nh h∆°n l√† 'for..of`. Ch·∫≥ng h·∫°n, ch√∫ng ta c√≥ th·ªÉ ph√¢n chia qu√° tr√¨nh l·∫∑p: l·∫∑p l·∫°i m·ªôt ch√∫t, sau ƒë√≥ d·ª´ng l·∫°i, l√†m m·ªôt c√°i g√¨ ƒë√≥ kh√°c, v√† sau ƒë√≥ ti·∫øp t·ª•c l·∫°i sau.

## Iterables and array-likes

C√≥ hai thu·∫≠t ng·ªØ ch√≠nh th·ª©c tr√¥ng gi·ªëng nhau, nh∆∞ng r·∫•t kh√°c nhau. H√£y ch·∫Øc ch·∫Øn r·∫±ng b·∫°n hi·ªÉu r√µ v·ªÅ ch√∫ng ƒë·ªÉ tr√°nh nh·∫ßm l·∫´n.

- *Iterables* l√† c√°c ƒë·ªëi t∆∞·ª£ng tri·ªÉn khai ph∆∞∆°ng th·ª©c `Symbol.iterator`, nh∆∞ ƒë∆∞·ª£c m√¥ t·∫£ ·ªü tr√™n.
- **Array-likes* l√† c√°c ƒë·ªëi t∆∞·ª£ng c√≥ ch·ªâ m·ª•c v√† `length`, v√¨ v·∫≠y ch√∫ng tr√¥ng gi·ªëng nh∆∞ m·∫£ng.

ƒê∆∞∆°ng nhi√™n, c√°c t√≠nh ch·∫•t n√†y c√≥ th·ªÉ k·∫øt h·ª£p. Ch·∫≥ng h·∫°n, c√°c chu·ªói ƒë·ªÅu c√≥ th·ªÉ iterable (`for..of` ho·∫°t ƒë·ªông tr√™n ch√∫ng) v√† array-like (ch√∫ng c√≥ c√°c ch·ªâ m·ª•c s·ªë v√† `length`).

Nh∆∞ng m·ªôt iterable c√≥ th·ªÉ kh√¥ng array-like. V√† ng∆∞·ª£c l·∫°i, m·ªôt array-like c√≥ th·ªÉ kh√¥ng iterable.

V√≠ d·ª•, `range` trong v√≠ d·ª• tr√™n l√† c√≥ th·ªÉ iterable, nh∆∞ng kh√¥ng array-like, v√¨ n√≥ kh√¥ng c√≥ c√°c thu·ªôc t√≠nh ƒë∆∞·ª£c l·∫≠p ch·ªâ m·ª•c v√† `length`.

V√† ƒë√¢y l√† ƒë·ªëi t∆∞·ª£ng array-like, nh∆∞ng kh√¥ng iterable:

```js
      let arrayLike = { // has indexes and length => array-like
        0: "Hello",
        1: "World",
        length: 2
      };

      // Error (no Symbol.iterator)
      for (let item of arrayLike) {}
```

Ch√∫ng c√≥ ƒë·∫∑c ƒëi·ªÉm g√¨ chung? C·∫£ iterables v√† array-likes th∆∞·ªùng *kh√¥ng ph·∫£i m·∫£ng*, ch√∫ng kh√¥ng c√≥ `push`, `pop`, v.v ... ƒêi·ªÅu ƒë√≥ kh√° b·∫•t ti·ªán n·∫øu ch√∫ng ta c√≥ m·ªôt ƒë·ªëi t∆∞·ª£ng nh∆∞ v·∫≠y v√† mu·ªën l√†m vi·ªác v·ªõi n√≥ nh∆∞ v·ªõi m·ªôt m·∫£ng.

## Array.from

C√≥ m·ªôt ph∆∞∆°ng th·ª©c ph·ªï bi·∫øn [Array.from](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/from) mang ch√∫ng l·∫°i v·ªõi nhau. N√≥ nh·∫≠n m·ªôt gi√° tr·ªã iterable ho·∫∑c array-like v√† t·∫°o ra m·ªôt `Array` "th·∫≠t" t·ª´ n√≥. Sau ƒë√≥ ch√∫ng ta c√≥ th·ªÉ g·ªçi c√°c ph∆∞∆°ng th·ª©c m·∫£ng tr√™n n√≥.

V√≠ d·ª•:

```js
      let arrayLike = {
        0: "Hello",
        1: "World",
        length: 2
      };

      let arr = Array.from(arrayLike); // (*)
      alert(arr.pop()); // World (method works)
```

`Array.from` t·∫°i d√≤ng `(*)` l·∫•y ƒë·ªëi t∆∞·ª£ng, ki·ªÉm tra xem n√≥ c√≥ ph·∫£i l√† d·∫°ng iterable ho·∫∑c array-like kh√¥ng, sau ƒë√≥ t·∫°o m·ªôt m·∫£ng m·ªõi v√† sao ch√©p t·∫•t c·∫£ c√°c items.

ƒêi·ªÅu t∆∞∆°ng t·ª± c≈©ng x·∫£y ra ƒë·ªëi v·ªõi m·ªôt iterable:

```js
      // assuming that range is taken from the example above
      let arr = Array.from(range);
      alert(arr); // 1,2,3,4,5 (array toString conversion works)
```

C√∫ ph√°p ƒë·∫ßy ƒë·ªß cho `Array.from` cho ph√©p cung c·∫•p m·ªôt t√πy ch·ªçn function "√°nh x·∫° (mapping)":

```js
      Array.from(obj[, mapFn, thisArg])
```

ƒê·ªëi s·ªë th·ª© hai `mapFn` ph·∫£i l√† h√†m ƒë·ªÉ √°p d·ª•ng cho t·ª´ng ph·∫ßn t·ª≠ tr∆∞·ªõc khi th√™m v√†o m·∫£ng v√† `thisArg` cho ph√©p ƒë·∫∑t `this` cho n√≥.

V√≠ d·ª•:

```js
      // assuming that range is taken from the example above

      // square each number
      let arr = Array.from(range, num => num * num);

      alert(arr); // 1,4,9,16,25
      ```

      ·ªû ƒë√¢y ch√∫ng ta s·ª≠ d·ª•ng `Array.from` ƒë·ªÉ bi·∫øn m·ªôt chu·ªói th√†nh m·ªôt m·∫£ng c√°c k√Ω t·ª±:

      ```js
      let str = 'ùí≥üòÇ';

      // splits str into array of characters
      let chars = Array.from(str);

      alert(chars[0]); // ùí≥
      alert(chars[1]); // üòÇ
      alert(chars.length); // 2
```

Kh√¥ng gi·ªëng nh∆∞ `str.split`, n√≥ d·ª±a v√†o t√≠nh ch·∫•t iterable c·ªßa chu·ªói v√† do ƒë√≥, gi·ªëng nh∆∞ `for..of`, ho·∫°t ƒë·ªông ch√≠nh x√°c v·ªõi c√°c c·∫∑p thay th·∫ø.

V·ªÅ m·∫∑t k·ªπ thu·∫≠t, n√≥ ho·∫°t ƒë·ªông gi·ªëng nh∆∞:

```js
      let str = 'ùí≥üòÇ';

      let chars = []; // Array.from internally does the same loop
      for (let char of str) {
        chars.push(char);
      }

      alert(chars);
```

...Nh∆∞ng ng·∫Øn h∆°n.    

Ch√∫ng ta th·∫≠m ch√≠ c√≥ th·ªÉ x√¢y d·ª±ng surrogate-aware `slice` tr√™n n√≥:

```js
      function slice(str, start, end) {
        return Array.from(str).slice(start, end).join('');
      }

      let str = 'ùí≥üòÇ©∑∂';

      alert( slice(str, 1, 3) ); // üòÇ©∑∂

      // native method does not support surrogate pairs
      alert( str.slice(1, 3) ); // garbage (two pieces from different surrogate pairs)
```

## T√≥m l∆∞·ª£c

C√°c ƒë·ªëi t∆∞·ª£ng c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng trong `for..of` ƒë∆∞·ª£c g·ªçi l√† *iterable*.

- V·ªÅ m·∫∑t k·ªπ thu·∫≠t, c√°c iterables ph·∫£i th·ª±c hi·ªán ph∆∞∆°ng th·ª©c c√≥ t√™n `Symbol.iterator`.
    - K·∫øt qu·∫£ c·ªßa `obj[Symbol.iterator]` ƒë∆∞·ª£c g·ªçi l√† *iterator*. N√≥ x·ª≠ l√Ω qu√° tr√¨nh l·∫∑p ƒëi l·∫∑p l·∫°i.
    - Tr√¨nh l·∫∑p ph·∫£i c√≥ ph∆∞∆°ng th·ª©c c√≥ t√™n `next()` tr·∫£ v·ªÅ m·ªôt ƒë·ªëi t∆∞·ª£ng `{done: Boolean, value: any}`, ·ªü ƒë√¢y `done:true` bi·ªÉu th·ªã k·∫øt th√∫c l·∫∑p, n·∫øu kh√¥ng th√¨ `value` l√† gi√° tr·ªã ti·∫øp theo.
- Ph∆∞∆°ng th·ª©c `Symbol.iterator` ƒë∆∞·ª£c g·ªçi t·ª± ƒë·ªông b·ªüi `for..of`, nh∆∞ng ch√∫ng ta c≈©ng c√≥ th·ªÉ tr·ª±c ti·∫øp th·ª±c hi·ªán n√≥.
- C√°c built-in iterables nh∆∞ chu·ªói ho·∫∑c m·∫£ng, c≈©ng tri·ªÉn khai `Symbol.iterator`.
- String iterator bi·∫øt v·ªÅ c√°c c·∫∑p thay th·∫ø.

C√°c ƒë·ªëi t∆∞·ª£ng c√≥ thu·ªôc t√≠nh ƒë∆∞·ª£c l·∫≠p ch·ªâ m·ª•c (indexed properties) v√† `length` ƒë∆∞·ª£c g·ªçi l√† *array-like*. C√°c ƒë·ªëi t∆∞·ª£ng nh∆∞ v·∫≠y c≈©ng c√≥ th·ªÉ c√≥ c√°c thu·ªôc t√≠nh v√† ph∆∞∆°ng th·ª©c kh√°c, nh∆∞ng thi·∫øu c√°c built-in methods c·ªßa m·∫£ng.

N·∫øu ch√∫ng ta nh√¨n v√†o b√™n trong ƒë·∫∑c t·∫£ -- ch√∫ng ta s·∫Ω th·∫•y r·∫±ng h·∫ßu h·∫øt c√°c built-in methods ƒë·ªÅu cho r·∫±ng ch√∫ng ho·∫°t ƒë·ªông v·ªõi c√°c iterables ho·∫∑c array-likes thay v√¨ m·∫£ng "th·ª±c", v√¨ ƒëi·ªÅu ƒë√≥ tr·ª´u t∆∞·ª£ng h∆°n.

`Array.from(obj[, mapFn, thisArg])` t·∫°o m·ªôt `Array` th·∫≠t t·ª´ m·ªôt iterable ho·∫∑c array-like `obj`, v√† ch√∫ng ta c√≥ th·ªÉ s·ª≠ d·ª•ng array methods tr√™n n√≥. C√°c ƒë·ªëi s·ªë t√πy ch·ªçn `mapFn` v√† `thisArg` cho ph√©p ch√∫ng ta √°p d·ª•ng m·ªôt h√†m cho m·ªói item.
